# План реализации правильной настройки системы LiveKit

## Обзор задач

Данный план содержит пошаговые задачи для реализации правильной настройки системы LiveKit на основе исчерпывающего справочника API. Задачи направлены на устранение текущих проблем с подключением и создание надежной системы согласно официальной спецификации.

## Задачи

- [x] 1. Реализация правильной системы аутентификации JWT
  - Создать класс `LiveKitAuthManager` для управления JWT токенами согласно спецификации
  - Реализовать создание токенов с обязательными полями (iss, sub, iat, exp, video)
  - Добавить автоматическое обновление токенов каждые 10 минут
  - Реализовать различные типы токенов (участник, админ, только просмотр)
  - Добавить валидацию прав доступа согласно VideoGrants спецификации
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2. Создание правильного API клиента LiveKit
  - Реализовать класс `LiveKitAPIClient` с правильными Twirp эндпоинтами
  - Добавить все методы RoomService API согласно спецификации
  - Реализовать правильные заголовки авторизации `Authorization: Bearer <token>`
  - Добавить обработку всех типов ошибок согласно HTTP кодам
  - Создать retry логику с экспоненциальным backoff
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3. Правильная настройка SIP конфигурации
  - Создать новый конфигурационный файл `livekit-sip-correct.yaml`
  - Настроить входящие и исходящие SIP транки согласно SIP API
  - Реализовать правила маршрутизации с `CreateSIPDispatchRule`
  - Добавить правильные настройки подключения (timeout, keep-alive, reconnect)
  - Настроить аудио кодеки согласно спецификации
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4. Реализация Egress сервиса для записи
  - Создать класс `LiveKitEgressService` для работы с Egress API
  - Реализовать Room Composite Egress с поддержкой MP4, OGG, RTMP, HLS
  - Добавить Track Composite Egress для синхронизации аудио/видео
  - Реализовать конфигурации для S3, Azure Blob, Google Cloud Storage
  - Добавить поддержку RTMP потокового вывода
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5. Реализация Ingress сервиса для импорта
  - Создать класс `LiveKitIngressService` для работы с Ingress API
  - Реализовать RTMP/RTMPS Ingress для OBS, XSplit
  - Добавить WHIP Ingress для WebRTC-HTTP протокола
  - Реализовать URL Input для HLS, MP4, MOV файлов
  - Добавить поддержку всех аудио форматов (OGG, MP3, M4A)
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 6. Создание системы мониторинга и диагностики
  - Создать класс `LiveKitSystemMonitor` для комплексного мониторинга
  - Реализовать health checks для всех API сервисов
  - Добавить мониторинг метрик производительности
  - Создать систему алертов для критических ошибок
  - Реализовать детальное логирование всех операций
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 7. Обновление конфигурации безопасности
  - Реализовать защиту API ключей от утечки в логах
  - Настроить обязательное использование WSS соединений
  - Добавить поддержку ротации ключей без downtime
  - Реализовать валидацию всех прав доступа
  - Создать мониторинг подозрительной активности
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 8. Оптимизация производительности системы
  - Реализовать connection pooling для LiveKit соединений
  - Добавить graceful reconnection при сбоях
  - Оптимизировать латентность аудио обработки
  - Реализовать ограничение одновременных комнат
  - Добавить мониторинг качества соединений
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 9. Интеграция с существующей Voice AI Agent системой
  - Обновить webhook обработчики для интеграции с LiveKit событиями
  - Адаптировать STT/TTS pipeline для работы с LiveKit треками
  - Интегрировать создание комнат с существующей логикой звонков
  - Обновить error handling для совместимости с новой системой
  - Интегрировать мониторинг с существующими системами
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 10. Создание новых конфигурационных файлов
  - Создать `config/livekit_config.py` с правильными настройками
  - Обновить `.env` файл с новыми переменными окружения
  - Создать `config/retry_policies.yaml` для retry логики
  - Добавить `config/monitoring.yaml` для настроек мониторинга
  - Создать `config/security.yaml` для настроек безопасности
  - _Requirements: 1.1, 8.1, 9.1_

- [x] 11. Обновление существующих компонентов
  - Обновить `src/webhooks.py` для поддержки LiveKit событий
  - Модифицировать `src/livekit_integration.py` с новым API клиентом
  - Обновить `src/voice_ai_agent.py` для работы с LiveKit комнатами
  - Адаптировать `src/sip_handler.py` для новой SIP конфигурации
  - Обновить все тесты для новой архитектуры
  - _Requirements: 10.1, 10.2, 10.3, 10.4_

- [ ] 12. Создание комплексной системы тестирования
  - Создать unit тесты для всех новых компонентов
  - Реализовать integration тесты для полного flow
  - Добавить тесты производительности и нагрузки
  - Создать тесты безопасности и валидации прав
  - Реализовать автоматические тесты для всех API эндпоинтов
  - _Requirements: 7.1, 8.4, 9.3_

- [x] 13. Создание документации и руководств
  - Создать руководство по настройке системы
  - Написать документацию по troubleshooting
  - Создать примеры использования всех API
  - Добавить схемы архитектуры и диаграммы
  - Создать руководство по мониторингу и обслуживанию
  - _Requirements: 7.5, 8.5_

- [ ] 14. Миграция и развертывание
  - Создать план миграции с существующей конфигурации
  - Реализовать blue-green deployment стратегию
  - Добавить rollback процедуры при проблемах
  - Создать скрипты для автоматического развертывания
  - Провести тестирование в staging environment
  - _Requirements: 1.1, 2.1, 3.1_

- [x] 15. Валидация и финальное тестирование
  - Провести полное тестирование всех компонентов
  - Валидировать работу с реальными SIP звонками
  - Проверить интеграцию с Voice AI Agent
  - Провести нагрузочное тестирование системы
  - Валидировать все требования безопасности
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1, 9.1, 10.1_

## Приоритеты выполнения

### Высокий приоритет (критично для работы):
- Задачи 1, 2, 3 - основа системы аутентификации и API
- Задача 9 - интеграция с существующей системой
- Задача 10 - новые конфигурационные файлы

### Средний приоритет (важно для стабильности):
- Задачи 6, 7, 8 - мониторинг, безопасность, производительность
- Задача 11 - обновление существующих компонентов
- Задача 12 - система тестирования

### Низкий приоритет (расширенная функциональность):
- Задачи 4, 5 - Egress и Ingress сервисы
- Задачи 13, 14 - документация и развертывание
- Задача 15 - финальная валидация

## Критерии готовности

### Для каждой задачи:
- [ ] Код написан и соответствует спецификации
- [ ] Unit тесты созданы и проходят
- [ ] Integration тесты проходят
- [ ] Документация обновлена
- [ ] Code review выполнен

### Для всего проекта:
- [ ] Все диагностические тесты проходят успешно
- [ ] Система работает с реальными SIP звонками
- [ ] Voice AI Agent корректно интегрирован
- [ ] Мониторинг и алерты настроены
- [ ] Производительность соответствует требованиям

## Временные оценки

- **Задачи 1-3**: 3-4 дня (критический путь)
- **Задачи 4-5**: 2-3 дня (параллельно)
- **Задачи 6-8**: 2-3 дня (параллельно)
- **Задачи 9-11**: 2-3 дня (после 1-3)
- **Задачи 12-15**: 2-3 дня (финализация)

**Общее время**: 7-10 рабочих дней при параллельном выполнении задач.

## Риски и митигация

### Основные риски:
1. **Несовместимость с существующей системой** - митигация через поэтапную интеграцию
2. **Проблемы с аутентификацией** - митигация через тщательное тестирование JWT токенов
3. **Производительность системы** - митигация через нагрузочное тестирование
4. **Сложность конфигурации** - митигация через автоматизацию и документацию

### План контингенции:
- Сохранение работающих backup конфигураций
- Возможность быстрого rollback к предыдущей версии
- Поэтапное развертывание с валидацией на каждом этапе