# Спецификация правильной настройки системы LiveKit

## Введение

На основе исчерпывающего справочника по API LiveKit необходимо создать правильную конфигурацию системы для устранения проблем с подключением к LiveKit серверу. Текущие проблемы включают ошибки аутентификации, неправильную конфигурацию SIP и проблемы с созданием комнат.

## Требования

### Requirement 1: Правильная настройка аутентификации LiveKit

**User Story:** Как администратор системы, я хочу чтобы система корректно аутентифицировалась с LiveKit сервером, используя правильные JWT токены и API ключи.

#### Acceptance Criteria

1. WHEN система инициализируется THEN должны быть правильно настроены API ключи из справочника
2. WHEN создается JWT токен THEN он должен содержать все обязательные поля согласно спецификации
3. WHEN выполняется запрос к API THEN должен использоваться правильный формат Twirp эндпоинтов
4. WHEN происходит аутентификация THEN должен использоваться заголовок `Authorization: Bearer <token>`
5. WHEN токен истекает THEN должно происходить автоматическое обновление (каждые 10 минут)

### Requirement 2: Корректная конфигурация RoomService API

**User Story:** Как разработчик, я хочу чтобы система правильно использовала RoomService API для создания и управления комнатами согласно спецификации.

#### Acceptance Criteria

1. WHEN создается комната THEN должен использоваться эндпоинт `/twirp/livekit.RoomService/CreateRoom`
2. WHEN настраивается комната THEN должны быть правильно установлены параметры:
   - `empty_timeout`: 300 секунд (по умолчанию)
   - `departure_timeout`: 20 секунд (по умолчанию)
   - `max_participants`: настраиваемое значение
   - `metadata`: JSON-строка с пользовательскими данными
3. WHEN управляются участники THEN должны использоваться правильные эндпоинты:
   - `ListParticipants`, `GetParticipant`, `RemoveParticipant`, `UpdateParticipant`
4. WHEN управляются треки THEN должны использоваться эндпоинты:
   - `MutePublishedTrack`, `UpdateSubscriptions`, `SendData`
5. WHEN требуются права THEN должны быть правильно настроены `roomCreate`, `roomAdmin`, `roomJoin`

### Requirement 3: Правильная настройка SIP интеграции

**User Story:** Как администратор SIP, я хочу чтобы SIP интеграция работала согласно спецификации SIP API LiveKit.

#### Acceptance Criteria

1. WHEN настраивается SIP транк THEN должен использоваться эндпоинт `CreateSIPInboundTrunk`
2. WHEN создается входящий транк THEN должны быть настроены параметры:
   - `name`: имя транка
   - `numbers`: список телефонных номеров
   - `allowed_addresses`: разрешенные IP-адреса
   - `auth_username` и `auth_password`: для аутентификации
3. WHEN настраивается маршрутизация THEN должен использоваться `CreateSIPDispatchRule`
4. WHEN создается SIP участник THEN должен использоваться `CreateSIPParticipant`
5. WHEN требуются права THEN должно быть установлено право `ingressAdmin`

### Requirement 4: Настройка Egress для записи и экспорта

**User Story:** Как администратор системы, я хочу чтобы система поддерживала все типы экспорта согласно Egress API спецификации.

#### Acceptance Criteria

1. WHEN настраивается Room Composite Egress THEN должен поддерживаться экспорт в MP4, OGG, RTMP, HLS
2. WHEN настраивается Track Composite Egress THEN должна быть синхронизация аудио и видео треков
3. WHEN настраивается файловый вывод THEN должны поддерживаться:
   - S3-совместимые хранилища
   - Azure Blob Storage
   - Google Cloud Storage
4. WHEN настраивается потоковый вывод THEN должен поддерживаться RTMP протокол
5. WHEN требуются права THEN должно быть установлено право `roomRecord`

### Requirement 5: Настройка Ingress для импорта медиа

**User Story:** Как администратор системы, я хочу чтобы система поддерживала импорт медиа согласно Ingress API спецификации.

#### Acceptance Criteria

1. WHEN настраивается RTMP/RTMPS Ingress THEN должен поддерживаться прием от OBS, XSplit
2. WHEN настраивается WHIP Ingress THEN должен поддерживаться WebRTC-HTTP Ingestion Protocol
3. WHEN настраивается URL Input THEN должны поддерживаться форматы:
   - HLS потоки, MP4, MOV файлы
   - MKV/WEBM контейнеры
   - OGG, MP3, M4A аудио
4. WHEN создается Ingress THEN должен использоваться эндпоинт `CreateIngress`
5. WHEN требуются права THEN должно быть установлено право `ingressAdmin`

### Requirement 6: Правильная настройка JWT токенов и прав доступа

**User Story:** Как разработчик безопасности, я хочу чтобы система использовала правильную структуру JWT токенов согласно спецификации.

#### Acceptance Criteria

1. WHEN создается JWT токен THEN должен содержать обязательные поля:
   - `iss`: api_key
   - `sub`: participant_identity
   - `iat`: время создания
   - `exp`: время истечения
   - `video`: права доступа
2. WHEN настраиваются права THEN должны быть правильно установлены Video Grant поля:
   - `roomCreate`, `roomList`, `roomJoin`, `roomAdmin`, `roomRecord`
   - `ingressAdmin`, `canPublish`, `canSubscribe`, `canPublishData`
   - `canUpdateOwnMetadata`, `canPublishSources`
3. WHEN создается токен для просмотра THEN должны быть установлены права:
   - `roomJoin: true`, `canSubscribe: true`
   - `canPublish: false`, `canPublishData: false`
4. WHEN создается токен для камеры THEN должны быть установлены:
   - `canPublishSources: ["camera"]`
5. WHEN токен истекает THEN должно происходить автоматическое обновление

### Requirement 7: Мониторинг и диагностика системы

**User Story:** Как администратор системы, я хочу иметь полную диагностику и мониторинг всех компонентов LiveKit согласно спецификации.

#### Acceptance Criteria

1. WHEN запускается диагностика THEN должны проверяться все эндпоинты API
2. WHEN проверяется подключение THEN должна тестироваться доступность всех сервисов:
   - RoomService, Egress, Ingress, SIP
3. WHEN мониторится система THEN должны отслеживаться метрики:
   - Количество успешных/неуспешных подключений
   - Латентность API запросов
   - Качество аудио/видео потоков
4. WHEN происходят ошибки THEN должно быть детальное логирование с кодами ошибок
5. WHEN система работает THEN должны быть health check endpoints

### Requirement 8: Безопасность и конфигурация

**User Story:** Как администратор безопасности, я хочу чтобы система была настроена согласно рекомендациям безопасности из спецификации.

#### Acceptance Criteria

1. WHEN хранятся API ключи THEN они должны быть защищены от утечки в логах
2. WHEN используются соединения THEN должны использоваться WSS подключения
3. WHEN происходит ротация ключей THEN должна поддерживаться смена без downtime
4. WHEN валидируются права THEN должна быть проверка всех разрешений
5. WHEN мониторится активность THEN должно быть отслеживание подозрительных действий

### Requirement 9: Производительность и оптимизация

**User Story:** Как администратор производительности, я хочу чтобы система была оптимизирована согласно рекомендациям из спецификации.

#### Acceptance Criteria

1. WHEN обрабатывается аудио THEN должна быть минимизирована латентность
2. WHEN используются соединения THEN должен быть connection pooling
3. WHEN происходят сбои THEN должно быть graceful reconnection
4. WHEN мониторится качество THEN должно отслеживаться качество соединений
5. WHEN используются ресурсы THEN должно быть ограничение одновременных комнат

### Requirement 10: Интеграция с существующей системой

**User Story:** Как разработчик интеграции, я хочу чтобы новая конфигурация LiveKit интегрировалась с существующей Voice AI Agent системой.

#### Acceptance Criteria

1. WHEN получается webhook THEN должна быть интеграция с существующими обработчиками
2. WHEN обрабатывается аудио THEN должна быть совместимость с STT/TTS pipeline
3. WHEN создаются комнаты THEN должна быть интеграция с существующей логикой звонков
4. WHEN происходят ошибки THEN должна быть совместимость с существующим error handling
5. WHEN мониторится система THEN должна быть интеграция с существующим мониторингом