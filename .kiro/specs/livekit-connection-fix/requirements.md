# Requirements Document

## Introduction

Необходимо исправить проблему подключения LiveKit SIP к LiveKit серверу и обеспечить корректную работу Voice AI Agent при входящих звонках. В настоящее время LiveKit SIP принимает звонки, но не может создать комнаты из-за ошибки аутентификации с LiveKit сервером ("auth check failed", "no response from servers").

## Requirements

### Requirement 1: Исправить подключение LiveKit SIP к серверу

**User Story:** Как администратор системы, я хочу чтобы LiveKit SIP успешно подключался к LiveKit серверу, чтобы входящие звонки могли создавать комнаты для обработки AI агентом.

#### Acceptance Criteria

1. WHEN LiveKit SIP получает входящий звонок THEN он должен успешно аутентифицироваться с LiveKit сервером
2. WHEN аутентификация проходит успешно THEN LiveKit SIP должен создать новую комнату с именем "voice-ai-call-{call_id}"
3. WHEN комната создана THEN должен быть отправлен webhook на http://agentio.ru:8000/webhooks/livekit
4. IF аутентификация не удается THEN должны быть логи с детальной информацией об ошибке
5. WHEN система работает корректно THEN в логах не должно быть ошибок "auth check failed" или "no response from servers"

### Requirement 2: Настроить корректную обработку webhook событий

**User Story:** Как разработчик Voice AI Agent, я хочу получать webhook события от LiveKit, чтобы агент мог подключиться к созданной комнате и начать обработку звонка.

#### Acceptance Criteria

1. WHEN LiveKit создает комнату THEN должен быть отправлен webhook "room_started"
2. WHEN участник присоединяется к комнате THEN должен быть отправлен webhook "participant_joined"
3. WHEN публикуется аудио трек THEN должен быть отправлен webhook "track_published"
4. WHEN Voice AI Agent получает webhook THEN он должен успешно обработать событие без ошибок
5. WHEN webhook обрабатывается THEN агент должен подключиться к комнате как участник

### Requirement 3: Обеспечить работу Voice AI Agent в LiveKit комнате

**User Story:** Как пользователь, я хочу чтобы при звонке на номер +79952227978 мне отвечал AI агент, который может слышать мою речь и отвечать голосом.

#### Acceptance Criteria

1. WHEN Voice AI Agent подключается к комнате THEN он должен публиковать аудио трек для воспроизведения ответов
2. WHEN пользователь говорит THEN агент должен получать аудио данные через LiveKit
3. WHEN агент получает аудио THEN он должен обработать речь через Deepgram STT
4. WHEN речь распознана THEN агент должен сгенерировать ответ через Groq LLM
5. WHEN ответ сгенерирован THEN агент должен синтезировать речь через Cartesia TTS
6. WHEN синтез завершен THEN агент должен воспроизвести ответ через LiveKit аудио трек
7. WHEN звонок завершается THEN агент должен корректно покинуть комнату

### Requirement 4: Диагностика и мониторинг подключения

**User Story:** Как администратор системы, я хочу иметь инструменты для диагностики проблем с LiveKit подключением, чтобы быстро выявлять и устранять неисправности.

#### Acceptance Criteria

1. WHEN запускается диагностика THEN должна быть проверена доступность LiveKit сервера
2. WHEN проверяются API ключи THEN должна быть валидация их корректности
3. WHEN тестируется подключение THEN должен быть создан тестовый запрос к LiveKit API
4. WHEN происходит ошибка THEN должны быть детальные логи с описанием проблемы
5. WHEN система работает THEN должны быть метрики успешности подключений

### Requirement 5: Конфигурация и безопасность

**User Story:** Как администратор системы, я хочу чтобы конфигурация LiveKit была безопасной и легко управляемой, чтобы обеспечить стабильную работу в продакшене.

#### Acceptance Criteria

1. WHEN настраивается конфигурация THEN API ключи должны быть защищены от утечки в логах
2. WHEN происходит подключение THEN должна использоваться безопасная WSS связь
3. WHEN конфигурация изменяется THEN должна быть возможность перезагрузки без перезапуска всей системы
4. WHEN система запускается THEN должна быть валидация всех обязательных параметров
5. WHEN происходят ошибки THEN должны быть механизмы автоматического переподключения