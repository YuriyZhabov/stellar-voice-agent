# API сервера LiveKit: Полное руководство и справочник
LiveKit представляет собой мощную платформу с открытым исходным кодом для создания приложений реального времени, включающих аудио, видео и обмен данными. Серверные API LiveKit предоставляют разработчикам полный контроль над управлением комнатами, участниками, записью, импортом медиа и телефонными функциями[1].

## Общая архитектура и принципы работы
LiveKit использует собственный протокол **Twirp** вместо традиционных REST API. Все серверные API построены на этой основе и отличаются от стандартных REST-интерфейсов тем, что аргументы передаются через POST-запросы с JSON-телом к специфическим эндпоинтам[1].

Каждый API доступен через паттерн URL `/twirp/livekit./`, где:
- **Egress**: `/twirp/livekit.Egress/`
- **Ingress**: `/twirp/livekit.Ingress/`  
- **Room Service**: `/twirp/livekit.RoomService/`
- **SIP**: `/twirp/livekit.SIP/`

Все эндпоинты требуют подписанный токен доступа, который должен быть установлен через HTTP-заголовок: `Authorization: Bearer `[1]. API LiveKit полностью распределены между несколькими узлами - любой экземпляр способен выполнять запросы о любой комнате, участнике, треке или правиле маршрутизации.
## RoomService API - Управление комнатами и участниками
RoomService API предоставляет комплексные возможности для управления комнатами, участниками, треками и данными. Это основной сервис для контроля над сессиями в реальном времени[1].

### Основные методы управления комнатами
**CreateRoom** создает новую комнату с указанными настройками и требует разрешения `roomCreate`. Хотя этот метод опционален, поскольку комната создается автоматически при подключении первого участника, он позволяет настроить параметры заранее[1]. Ключевые параметры включают имя комнаты, таймауты простоя и ухода участников, максимальное количество участников, метаданные и настройки автоматической записи.

**ListRooms** возвращает список активных комнат и требует разрешения `roomList`. Метод может фильтровать результаты по именам комнат, если передать параметр `names`[1].

**DeleteRoom** принудительно удаляет существующую комнату, отключая всех участников, и требует разрешения `roomCreate`[1].

### Управление участниками
**ListParticipants** и **GetParticipant** предоставляют информацию об участниках в комнате, требуя разрешения `roomAdmin`. Первый возвращает список всех участников, второй - подробную информацию о конкретном участнике по его идентификатору[1].

**RemoveParticipant** удаляет участника из комнаты, **UpdateParticipant** обновляет метаданные и разрешения участника. Обновление метаданных транслируется всем остальным участникам в комнате[1].

### Контроль треков и данных
**MutePublishedTrack** позволяет заглушать или включать треки участников. По умолчанию LiveKit сервер настроен на запрет удаленного включения треков из соображений конфиденциальности, но это можно изменить установкой `enable_remote_unmute` в true[1].

**UpdateSubscriptions** управляет подписками участников на опубликованные треки. Как администратор, вы можете подписать участника на трек, даже если у него нет разрешения `canSubscribe`[1].

**SendData** отправляет пакеты данных одному или нескольким участникам в комнате, поддерживая как надежную, так и ненадежную доставку[1].

## Egress API - Экспорт и запись
Egress API предоставляет мощные возможности для экспорта любой комнаты или отдельных треков из сессии LiveKit. Он поддерживает запись в файлы MP4, HLS-сегменты, а также экспорт в стриминговые сервисы через RTMP[2][3].

### Типы экспорта
**Room Composite Egress** экспортирует всю комнату целиком, используя веб-макет, отрендеренный в Chrome. Такие записи привязаны к жизненному циклу комнаты и автоматически останавливаются при завершении сессии[3].

**Track Composite Egress** синхронизирует и экспортирует до одного аудио и одного видео трека с перекодированием и мультиплексированием[3].

**Track Egress** экспортирует отдельные треки напрямую без перекодирования видео. Это полезно для передачи аудио трека в сервис транскрипции через WebSocket[3].

**Participant Egress** - более новый API, предназначенный для экспорта видео и аудио участника вместе, что проще в использовании чем Track Composite Egress[3].

### Методы Egress API
API включает методы для запуска различных типов записи (`StartRoomCompositeEgress`, `StartTrackEgress`, `StartTrackCompositeEgress`), управления активными записями (`UpdateLayout`, `ListEgress`) и их остановки (`StopEgress`)[2]. Все запросы к Egress API требуют разрешения `roomRecord` в токене доступа[2].

## Ingress API - Импорт медиа контента
Ingress API позволяет импортировать видео из внешних источников в комнату LiveKit. Это особенно важно для интеграции с существующими рабочими процессами или оборудованием, не поддерживающим WebRTC[4].

### Поддерживаемые источники
Ingress поддерживает широкий спектр источников медиа: RTMP/RTMPS, WHIP, медиафайлы с HTTP-серверов (включая HLS, MP4, MOV, MKV/WEBM, OGG, MP3, M4A) и контент с SRT-серверов[4].

### Рабочий процесс
Для WHIP/RTMP источников процесс следующий: приложение создает Ingress через API `CreateIngress`, получая URL и ключ потока; пользователь копирует эти данные в свое ПО для стриминга; при запуске потока Ingress Service начинает перекодирование и публикует медиа в LiveKit комнату[4].

Для URL Input процесс начинается немедленно после вызова `CreateIngress` - Ingress Service начинает загрузку и перекодирование файла, присоединяется к комнате и публикует медиа[4].

### Методы Ingress API
**CreateIngress** создает новый ingress с настройками источника медиа, комнаты назначения и параметров участника. **UpdateIngress** позволяет изменять конфигурацию для повторного использования того же URL для публикации в разные комнаты. **ListIngress** возвращает список активных ingress, а **DeleteIngress** удаляет ненужные ingress[4].

## SIP API - Интеграция с телефонией
SIP API расширяет возможности LiveKit для интеграции с традиционными телефонными системами, позволяя принимать и совершать звонки через SIP-протокол[5][6].

### Концепции SIP
API оперирует двумя ключевыми концепциями: **транки** (trunks) и **правила маршрутизации** (dispatch rules). Транки соединяют вашего SIP-провайдера с LiveKit - входящие транки обрабатывают входящие вызовы, исходящие используются для исходящих звонков[6].

Правила маршрутизации связаны с конкретным транком и контролируют, как входящие вызовы направляются в комнаты LiveKit. Все звонящие могут быть помещены в одну комнату или в разные, в зависимости от правил[6].

### SIP участники
Каждый звонящий, принимающий вызов и AI голосовой агент, участвующий в звонке, является участником LiveKit с теми же атрибутами и метаданными, что и обычные участники, плюс дополнительные SIP-специфичные атрибуты[6].

### Методы SIP API
**CreateSIPInboundTrunk** и **CreateSIPOutboundTrunk** создают транки для входящих и исходящих вызовов соответственно. **CreateSIPDispatchRule** создает правила маршрутизации вызовов в комнаты. **CreateSIPParticipant** инициирует исходящий SIP-вызов[5].

## Аутентификация и управление токенами
Для подключения любого LiveKit SDK к серверу требуется токен доступа, который кодирует идентификатор участника, имя комнаты, возможности и разрешения. Токены основаны на JWT и подписаны вашим API-секретом для предотвращения подделки[7].

### Создание токенов
Токены содержат время истечения, после которого сервер будет отклонять подключения. Важно отметить, что время истечения влияет только на первоначальное подключение, но не на последующие переподключения[7].

Базовый пример создания токена на Python:
```python
from livekit import api
token = api.AccessToken() \
    .with_identity("python-bot") \
    .with_name("Python Bot") \
    .with_grants(api.VideoGrants(
        room_join=True,
        room="my-room",
    )).to_jwt()
```

### Разрешения в токенах
Video grant в токене может содержать различные разрешения: `roomCreate` для создания/удаления комнат, `roomList` для получения списка комнат, `roomJoin` для входа в комнату, `roomAdmin` для модерации, `roomRecord` для использования Egress, `ingressAdmin` для Ingress сервиса[7].

## SDK для различных языков программирования
LiveKit предоставляет обширную экосистему SDK для множества языков программирования и платформ, поддерживая как серверные, так и клиентские приложения[8][9][10].

### Серверные SDK
**Python** предлагает три основных пакета: `livekit-api` для управления комнатами и создания токенов, `livekit` для подключения как участник в реальном времени, и `livekit-agents` для создания AI агентов[8].

**Node.js** включает `livekit-server-sdk` для управления комнатами и токенов, а также `@livekit/agents` для создания AI агентов (в beta-версии)[9].

**Go** SDK (`github.com/livekit/server-sdk-go/v2`) предоставляет полный контроль над сервером, включая управление комнатами, создание токенов и обработку веб-хуков[10].

**Ruby, Java/Kotlin, PHP, Rust** также имеют соответствующие серверные SDK с базовой функциональностью управления API и создания токенов[8].

### Клиентские SDK
Клиентские SDK доступны для **JavaScript** (браузеры), **Swift** (iOS/macOS/visionOS), **Android**, **Flutter**, **React Native**, **Unity**, обеспечивая подключение к комнатам, управление аудио/видео и обмен данными.

### Agents Framework
Agents Framework позволяет добавлять программы Python или Node.js в любую комнату LiveKit как полноценных участников реального времени. SDK включает полный набор инструментов для обработки потокового ввода и генерации вывода через AI pipeline[11].

## Практические примеры использования
### Базовое создание комнаты через API
```bash
curl -X POST /twirp/livekit.RoomService/CreateRoom \
  -H "Authorization: Bearer " \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "my-conference-room",
    "max_participants": 50,
    "empty_timeout": 600,
    "departure_timeout": 30
  }'
```

### Запуск записи комнаты
```bash
curl -X POST /twirp/livekit.Egress/StartRoomCompositeEgress \
  -H "Authorization: Bearer " \
  -H 'Content-Type: application/json' \
  -d '{
    "room_name": "my-conference-room",
    "file": {
      "filename": "recording.mp4",
      "s3": {
        "access_key": "your-key",
        "secret": "your-secret",
        "bucket": "recordings-bucket",
        "region": "us-east-1"
      }
    }
  }'
```

### Создание Ingress для RTMP
```bash
curl -X POST /twirp/livekit.Ingress/CreateIngress \
  -H "Authorization: Bearer " \
  -H 'Content-Type: application/json' \
  -d '{
    "input_type": 0,
    "name": "OBS Stream",
    "room_name": "streaming-room",
    "participant_identity": "streamer-1",
    "participant_name": "Main Streamer"
  }'
```

## Заключение
API сервера LiveKit представляет собой мощную и гибкую платформу для создания приложений реального времени. Четыре основных сервиса - RoomService, Egress, Ingress и SIP - покрывают все аспекты современной коммуникации: от базового управления комнатами до интеграции с телефонией и AI агентами.

Использование протокола Twirp и распределенная архитектура обеспечивают масштабируемость и надежность, а богатая экосистема SDK позволяет интегрировать LiveKit практически с любой технологической стекой. Это делает платформу идеальным выбором для разработки от простых видеоконференций до сложных мультимодальных AI приложений.